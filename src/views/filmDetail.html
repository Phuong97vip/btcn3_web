<!-- src\views\filmDetail.html -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bài tập cá nhân 3</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"></script>
  <script src="/Js/jquery.js"></script>
  <link rel="stylesheet" href="/Css/style.css">
</head>

<body class="bg">
  <div class="container-fluid">
    <!-- Header -->
    <div class="row ">
      <nav class="navbar bg-body-tertiary rounded border border-light pt-3 pb-3  mb-2" data-bs-theme="theme">
        <div class="container-fluid  ">
          <h1 class="navbar-brand fs-6 w-25">21120534</h1>
          <h1 class="navbar-brand fs-1">Movie Infomation</h1>
          <div class="navbar-brand d-flex flex-column align-items-end w-25">
            <div class="form-check form-switch">
              <input class="form-check-input inputDarkMode" 21534{if darkMode} checked {else} {/if} type="checkbox"
                role="switch" id="flexSwitchCheckDefault">
              <label class="form-check-label" for="flexSwitchCheckDefault">Dark mode</label>
            </div>
          </div>
        </div>
      </nav>
    </div>

    <!-- Navigation-->
    <div class="row mb-2">
      <nav class="navbar bg-body-tertiary rounded border border-light " :data-bs-theme="theme">
        <div class="container-fluid  ">
          <a class="navbar-brand homeButton" href="/"><svg xmlns="http://www.w3.org/2000/svg" height="1em"
              viewBox="0 0 576 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
              <style>
                svg {
                  fill: #000000
                }
              </style>
              <path
                d="M575.8 255.5c0 18-15 32.1-32 32.1h-32l.7 160.2c0 2.7-.2 5.4-.5 8.1V472c0 22.1-17.9 40-40 40H456c-1.1 0-2.2 0-3.3-.1c-1.4 .1-2.8 .1-4.2 .1H416 392c-22.1 0-40-17.9-40-40V448 384c0-17.7-14.3-32-32-32H256c-17.7 0-32 14.3-32 32v64 24c0 22.1-17.9 40-40 40H160 128.1c-1.5 0-3-.1-4.5-.2c-1.2 .1-2.4 .2-3.6 .2H104c-22.1 0-40-17.9-40-40V360c0-.9 0-1.9 .1-2.8V287.6H32c-18 0-32-14-32-32.1c0-9 3-17 10-24L266.4 8c7-7 15-8 22-8s15 2 21 7L564.8 231.5c8 7 12 15 11 24z" />
            </svg></a>
          <a class="navbar-brand favpage">21534</a>
          <a class="btn btn-primary ms-auto" href="/movies/add">Go to Add Movie Page</a>
          <form action="/search" method="post" class="d-flex justify-content-end searchForm w-50" role="search">
            <input name="searchString" class="form-control me-2 w-50" type="search" placeholder="Search"
              aria-label="Search" data-bs-theme="light">
            <button class="btn btn-outline-success w-25  me-2" type="submit">Search</button>
            <div class="btn-group mr-5  me-2" role="group">
              <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown"
                aria-expanded="false">
                searchType
              </button>
              <ul class="dropdown-menu">
                <li>
                  <div class="form-check dropdown-item">
                    <input class="form-check-input" type="radio" name="searchType" id="exampleRadios1" value="Actor"
                      checked>
                    <label class="form-check-label" for="exampleRadios1">
                      Actor
                    </label>
                  </div>
                </li>
                <li>
                  <div class="form-check dropdown-item">
                    <input class="form-check-input" type="radio" name="searchType" id="exampleRadios1" value="Type"
                      checked>
                    <label class="form-check-label" for="exampleRadios1">
                      Type
                    </label>
                  </div>
                </li>
                <li>
                  <div class="form-check dropdown-item ">
                    <input class="form-check-input" type="radio" name="searchType" id="exampleRadios1" value="Title"
                      checked>
                    <label class="form-check-label" for="exampleRadios1">
                      Title
                    </label>
                  </div>
                </li>
              </ul>
            </div>
          </form>
        </div>
      </nav>
    </div>


    <!-- Content -->
    21534{if hasData}
    <div>
      <div class="row p-5">
        <p class="display-1 " :class="{'text-light' : darkMode}">21534{movies.title}</p>
        <div id="carouselExampleFade" class="carousel slide carousel-fade detailSlider">
          <div class="carousel-inner carImage">
          </div>
          <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleFade"
            data-bs-slide="prev">
            <span class="carousel-control-prev-icon bg-dark " aria-hidden="true"></span>
            <span class="visually-hidden ">Previous</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleFade"
            data-bs-slide="next">
            <span class="carousel-control-next-icon bg-dark" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
          </button>

        </div>
      </div>
      <div class="row p-5">
        <p class="display-3 " :class="{'text-light' : darkMode}">General information</p>
        <div class="card">
          <div class="card-body">
            <table class="table">
              <tbody>
                <tr>
                  <th class="custom-width">Title</th>
                  <td>21534{movies.title}</td>
                </tr>
                <tr>
                  <th>Year</th>
                  <td>21534{movies.year}</td>

                </tr>
                <tr>
                  <th>Director</th>
                  <td id="directorList">
                  </td>
                </tr>
                <tr>
                  <th>Actor</th>
                  <td id="actorList">
                  </td>
                </tr>
                <tr>
                  <th>Type</th>
                  <!-- <td>{{film.type}}</td> -->
                </tr>
                <tr>
                  <th>Plot Full</th>
                  <td>21534{movies.plotFull}</td>
                </tr>
              </tbody>
            </table>
            <button class="btn-primary btn w-100 addButton " type="button">ADD FAVOUTITE</button>
          </div>
        </div>

      </div>
      <div class="row p-5">
        <p class="display-3 " :class="{'text-light' : darkMode}">Review</p>
        <div class="card">
          <nav aria-label="Page navigation example">
            <ul class="pagination">
              <li class="page-item pre">
                <a class="page-link" aria-label="Previous">
                  <span aria-hidden="true">&laquo;</span>
                </a>
              </li>
              <li class="page-item w-25 text-center currentPageShow"></li>
              <li class="page-item next">
                <a class="page-link " aria-label="Next">
                  <span aria-hidden="true">&raquo;</span>
                </a>
              </li>
            </ul>
          </nav>
           <!-- Add Review Button -->
           <div class="card-footer text-end">
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addReviewModal">Add Review</button>
          </div>
          <div class="card-body reviewList">


          </div>
         
        </div>
      </div>
    </div>
    {else}
    <div>
      <div class="alert alert-danger " role="alert">
        <h4 class="alert-heading">Data Not Found or Currently Being Updated</h4>
        <p>I apologize for the inconvenience. The data you are looking for is currently unavailable or in the process of
          being updated. We understand the importance of this information to you and are working diligently to resolve
          this issue. We appreciate your patience and understanding during this time.</p>
        <hr>
        <p class="mb-0">Best Regards, TRAN VAN PHUONG.</p>
      </div>
    </div>
    {/if}

    <!-- Footer -->
    <div class="row ">
      <nav class="navbar bg-body-tertiary rounded border border-light p-3 mb-2" :data-bs-theme="theme">
        <div class="container-fluid ">
          <h1 class="navbar-brand fs-6 ">footer 21120534 TRAN VAN PHUONG</h1>
        </div>
      </nav>
    </div>

  </div>

  <!-- Add Review Modal -->
  <div class="modal fade" id="addReviewModal" tabindex="-1" aria-labelledby="addReviewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="addReviewForm">
          <div class="modal-header">
            <h5 class="modal-title" id="addReviewModalLabel">Add Your Review</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Username -->
            <div class="mb-3">
              <label for="username" class="form-label">Username <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="username" name="username" required>
            </div>
            <!-- Rate -->
            <div class="mb-3">
              <label for="rate" class="form-label">Rate (1-5) <span class="text-danger">*</span></label>
              <select class="form-select" id="rate" name="rate" required>
                <option value="">Select Rate</option>
                <option value="1">1 - Very Bad</option>
                <option value="2">2 - Bad</option>
                <option value="3">3 - Okay</option>
                <option value="4">4 - Good</option>
                <option value="5">5 - Excellent</option>
              </select>
            </div>
            <!-- Title -->
            <div class="mb-3">
              <label for="title" class="form-label">Review Title</label>
              <input type="text" class="form-control" id="title" name="title">
            </div>
            <!-- Content -->
            <div class="mb-3">
              <label for="content" class="form-label">Review Content</label>
              <textarea class="form-control" id="content" name="content" rows="3"></textarea>
            </div>
            <!-- Warnings Spoilers -->
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="warningspoilers" name="warningspoilers">
              <label class="form-check-label" for="warningspoilers">
                Contains spoilers
              </label>
            </div>
            <!-- Hidden Movie ID -->
            <input type="hidden" id="movieid" name="movieid" value="21534{movies.id}">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Submit Review</button>
          </div>
        </form>
      </div>
    </div>
  </div>

</body>

<script>


  let dark = false;
  const updateMode = () => {
    if ($('.inputDarkMode').is(':checked')) {
      $('.bg').toggleClass('bg-dark')
      $('.bg').removeClass('bg-body-secondary')
      $('.heading').toggleClass('text-light');
      $('.heading').removeClass('text-dark');
      $('.searchForm').attr('action', `/search/dark=true`);
      $('.homeButton').attr('href', `/dark=true`);
      return true;
    } else {
      $('.bg').toggleClass('bg-body-secondary')
      $('.bg').removeClass('bg-dark')
      $('.heading').toggleClass('text-dark');
      $('.heading').removeClass('text-light');
      $('.searchForm').attr('action', `/search/dark=false`);
      $('.homeButton').attr('href', `/dark=false`);
      return false
    }
  }
  dark = updateMode();
  $('.inputDarkMode').on('change', (e) => {
    dark = updateMode();
  })

  let currentPage = 1;
  let perPage = 3;
  let numberOfPage = 0
  const generateImageList = async () => {
    let picList = await fetch(`../../../api/movies/pic/id=21534{movies.id}`);
    picList = await picList.json();
    for (let i = 0; i < picList.length; i++) {
      let htmlString = `<div class="carousel-item">
              <img src="${picList[i].image}" class="d-block w-50 mx-auto " alt="${picList[i].image}">
            </div>`;
      let domObject = $(htmlString);
      if (i == 0) domObject.addClass('active')
      $('.carImage').append(domObject);
    }
  }
  const generateDirectorList = async () => {
    let directorList = await fetch(`../../../api/movies/director/id=21534{movies.id}`)
    directorList = await directorList.json();
    let str = "";
    for (let i = 0; i < directorList.length; i++) {
      str += directorList[i].name;
      if (i != directorList.length - 1) str += ", ";
    }
    $('#directorList').append(str);
  }
  const generateActorList = async () => {
    let domain = $(`<p></p>`)
    let actorList = await fetch(`../../../api/movies/actor/id=21534{movies.id}`)
    actorList = await actorList.json();
    for (let i = 0; i < actorList.length; i++) {
      domain.append(`<a href='../../../detail/actor/id=${actorList[i].id}/dark=${dark}'>${actorList[i].name}</a>`)
      if (i != actorList.length - 1) domain.append(', ')
    }
    $('#actorList').append(domain);
  }
  const generateReview = async () => {
    let reviewList = await fetch(`../../../api/review/id=21534{movies.id}/per_page=${perPage}/page=${currentPage}`);
    reviewList = await reviewList.json();
    for (const review of reviewList.reviews) {
      $('.reviewList').append(`
      <div class="card mb-3">
        <div class="row g-0">
          <div class="col-12">
            <div class="card-body">
              <h5 class="card-title">${review.username}</h5>
              <p class="card-text display-3">${review.rate}</p>
              <p class="card-text">${review.title}</p>
              <p class="card-text">${review.content}</p>
              <p class="card-text"><small class="text-body-secondary">${review.date}</small></p>
            </div>
          </div>
        </div>
      </div>
      `)
    }
    numberOfPage = Math.ceil(reviewList.total / reviewList.perPage)
    $('.currentPageShow').text(`${reviewList.page} / ${numberOfPage}`)
  }
  generateImageList();
  generateDirectorList();
  generateActorList();
  generateReview();

  $('.pre').on('click', async () => {
    if (currentPage > 1) {
      $('.reviewList').empty();
      $('.currentPageShow').empty();
      currentPage -= 1;
      await generateReview();
    }
  })
  $('.next').on('click', async () => {
    if (currentPage < numberOfPage) {
      $('.reviewList').empty();
      $('.currentPageShow').empty();
      currentPage += 1;
      await generateReview();
    }
  })
  $('.favpage').on('click', () => {
    window.location.href = `/fav/dark=${dark}`;
  })

  $('.addButton').on('click', async () => {
    let check = await fetch(`../../../api/movies/fav/add/id=21534{movies.id}`)
    check = await check.json();
    if (check) {
      alert("Thêm thành công!");
    } else {
      alert("Thêm không thành công!");
    }
  })

  // Add Review Functionality
  $(document).ready(function () {
    $('#addReviewForm').on('submit', async function (e) {
      e.preventDefault();

      // Gather form data
      const reviewData = {
        movieid: $('#movieid').val(),
        username: $('#username').val().trim(),
        warningspoilers: $('#warningspoilers').is(':checked'),
        rate: parseInt($('#rate').val()),
        title: $('#title').val().trim(),
        content: $('#content').val().trim()
      };

      // Basic validation
      if (!reviewData.username || !reviewData.rate) {
        alert('Please fill in the required fields.');
        return;
      }

      try {
        const response = await fetch('/api/review/add', { // Adjust the endpoint as per your routing
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(reviewData)
        });

        const result = await response.json();

        if (response.ok) {
          alert(result.message || 'Review added successfully!');
          // Close the modal
          $('#addReviewModal').modal('hide');
          // Reset the form
          $('#addReviewForm')[0].reset();
          // Refresh the review list
          $('.reviewList').empty();
          currentPage = 1;
          generateReview();
        } else {
          alert(result.message || 'Failed to add the review.');
        }
      } catch (error) {
        console.error('Error adding review:', error);
        alert('An error occurred while adding your review. Please try again later.');
      }
    });
  });
</script>

</html>
